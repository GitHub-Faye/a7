# 任务6.2 - Standardize n8n Webhook formats

## 任务描述
- **任务ID**: 6.2
- **任务名称**: Standardize n8n Webhook formats
- **描述**: 定义和标准化专门用于n8n Webhook集成的请求/响应格式
- **依赖**: 任务6.1 (Design n8n Webhook service layer) - 已完成
- **状态**: 待处理

## 当前状态分析
通过代码分析，我发现n8n Webhook服务层已经实现，但请求和响应格式尚未完全标准化。目前存在以下情况：

1. **现有请求格式**:
   - 客户端 -> API视图:
     ```json
     {
       "task_type": "ragAI",
       "data": {
         "chatInput": "用户输入问题",
         "sessionId": "用户会话ID"
       },
       "webhook_id": 1  // 可选
     }
     ```
   - API视图 -> n8n服务:
     ```json
     {
       "task_type": "ragAI",
       "data": {
         "chatInput": "用户输入问题",
         "sessionId": "用户会话ID"
       }
     }
     ```

2. **现有响应格式**:
   - n8n服务 -> API视图:
     ```json
     {
       "result": "success",
       "answer": "生成的回答",
       "sources": [
         {"title": "来源标题", "url": "来源URL"}
       ]
     }
     ```
   - API视图 -> 客户端:
     ```json
     {
       "success": true,
       "status_code": 200,
       "data": {
         "result": "success",
         "answer": "生成的回答",
         "sources": [
           {"title": "来源标题", "url": "来源URL"}
         ]
       }
     }
     ```

3. **现有错误处理**:
   - API错误响应:
     ```json
     {
       "error": true,
       "message": "错误描述"
     }
     ```

## 标准化需求
需要规范以下几个方面:

1. **请求格式标准化**:
   - 为不同AI任务类型定义标准化请求结构
   - 确保请求结构与n8n的期望格式匹配
   - 明确定义必需和可选参数

2. **响应格式标准化**:
   - 定义不同任务类型的标准响应结构
   - 确保响应结构包含所有必要信息
   - 标准化错误响应格式

3. **任务类型扩展支持**:
   - 除已有的ragAI类型外，支持更多任务类型
   - 为每种任务类型定义专门的请求/响应格式

## 实施计划

1. **创建格式定义模块**:
   - 在`ai_services/services/n8n_webhook/`目录下创建`formats.py`模块
   - 定义用于验证和构建请求/响应的类和函数

2. **请求格式标准化**:
   - 实现`format_request`函数用于格式化发送到n8n的请求
   - 实现不同任务类型的请求验证函数
   - 将请求验证和格式化集成到视图和客户端中

3. **响应格式标准化**:
   - 实现`parse_response`函数用于解析和验证n8n的响应
   - 为不同任务类型定义响应验证规则
   - 确保错误响应格式一致性

4. **测试和文档**:
   - 在测试文件中添加格式验证测试用例
   - 为不同任务类型添加示例请求和响应
   - 更新API文档中的格式说明

## 具体任务拆分

### 1. 创建格式定义模块 (formats.py)
- 定义基础格式验证类
- 实现任务类型注册机制
- 添加格式转换和验证工具函数

### 2. 实现请求格式标准化
- 为ragAI任务类型定义标准请求格式
- 实现请求验证和格式化函数
- 为其他任务类型预留扩展点

### 3. 实现响应格式标准化
- 为ragAI任务类型定义标准响应格式
- 实现响应解析和验证函数
- 标准化错误响应格式

### 4. 更新客户端和视图
- 整合格式验证到`N8nWebhookClient`中
- 更新`N8nWebhookAPIView`使用标准化格式
- 确保错误处理使用标准格式

### 5. 测试和文档
- 添加格式验证单元测试
- 更新集成测试使用标准化格式
- 添加格式文档和使用示例
